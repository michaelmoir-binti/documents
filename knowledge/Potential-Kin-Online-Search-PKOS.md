# Potential Kin Online Search (PKOS) Feature

## Overview

**Potential Kin Online Search (PKOS)**, also known as **Clear Person Search** or **Integrated Person Search**, is a feature that allows child welfare workers to search for potential relatives and connections for children in care using external data sources. The feature integrates with **Thomson Reuters CLEAR** (a public records and data intelligence platform) to find potential family members, relatives, and associates.

---

## Purpose

The PKOS feature helps child welfare workers:

1. **Find Missing Family Members**: Locate relatives who may not be in the system
2. **Expand Family Networks**: Discover extended family members and connections
3. **Verify Information**: Cross-reference information about known connections
4. **Build Family Trees**: Identify relationships and connections between people
5. **Create Connections**: Link discovered people as potential connections in the system

---

## Key Terminology

- **PKOS**: Potential Kin Online Search
- **Clear Person Search**: The search query sent to Thomson Reuters CLEAR
- **Clear Person Report** / **Comprehensive Search**: The detailed report generated by CLEAR with potential relatives and associates
- **Potential Relatives**: People identified as potential family members (blood relatives)
- **Potential Associates** / **Fictive Kin**: People identified as potential connections (non-blood relatives, friends, associates)
- **Entity ID**: Unique identifier from CLEAR for a person
- **Group ID**: Identifier for a group of related search results

---

## Architecture

### External Integration

**Thomson Reuters CLEAR API**
- Provides public records and data intelligence
- Returns search results with personal information, addresses, phone numbers, etc.
- Generates comprehensive reports with potential relatives and associates
- Logo displayed in UI: `thomson-reuters-logo.png`

### Internal Components

1. **Search Form**: User enters search criteria
2. **Search Results**: Initial matches from CLEAR
3. **Comprehensive Report**: Detailed report with potential kin (requires separate request)
4. **Connection Linking**: Ability to create connections from search results

---

## User Flow

### Flow 1: Basic Search

```
1. User navigates to PKOS search page
   → /family_finding/potential_kin_search/new
   
2. User enters search criteria:
   - Name (first, middle, last)
   - Date of birth
   - SSN
   - Phone number
   - Email
   - Address
   - Age range
   - Driver's license
   - Entity ID
   
3. User clicks "Search"
   → Creates ClearPersonSearch record
   → Sends search to CLEAR API
   
4. System displays initial search results
   → Shows matches with basic information
   → User can view details or run comprehensive search
```

### Flow 2: Comprehensive Search (Detailed Report)

```
1. User views search result details
   → Clicks "More Details" on a result
   
2. User clicks "Run Comprehensive Search" button
   → Creates ClearPersonReport record
   → Triggers comprehensive report generation
   
3. System polls for report completion
   → Polls every 1 second
   → Shows loading state
   
4. Report completes (status 200)
   → Displays two tabs:
     - Personal Information
     - Potential Kin
   → Shows potential relatives and associates
```

### Flow 3: Linking as Connection

```
1. User views potential kin results
   → Sees list of potential relatives/associates
   
2. User clicks "Link as Potential Connection"
   → Opens modal to select:
     - Which children to link
     - Which data fields to include
   
3. User selects data to include:
   - Name fields
   - Date of birth/death
   - SSN
   - Addresses
   - Phone numbers
   - Email addresses
   - Social media links
   - Risk flags
   
4. System creates AgencyHuman record
   → Creates relationship to selected children
   → Includes selected data fields
   
5. Connection appears in Relationships dashboard
```

---

## Search Criteria

### Required Fields

The search requires **valid combinations** of fields. Some combinations are invalid (too vague):

**Invalid Combinations** (too vague, won't return useful results):
- First name only
- First name + middle name only
- First name + city only
- Middle name only
- Date of birth only
- Address components alone (address line 1, city, state, zip individually)

**Valid Combinations** (examples):
- First name + Last name + Date of birth
- First name + Last name + Address
- First name + Last name + Phone number
- Last name + SSN
- Entity ID (if searching for existing CLEAR record)

### Search Fields

1. **Name Fields**
   - First name
   - Middle name
   - Last name
   - Flexible search (fuzzy matching)

2. **Identity Fields**
   - Date of birth
   - SSN
   - Driver's license number
   - Entity ID (CLEAR's unique identifier)

3. **Age Range**
   - Minimum age
   - Maximum age

4. **Contact Information**
   - Phone number
   - Email address

5. **Address**
   - Address line 1
   - Address line 2
   - City
   - State (dropdown from US states)
   - ZIP code

---

## Data Structure

### ClearPersonSearch (Basic Search)

Stores the search criteria and initial results:

```ruby
{
  id: "123",
  searchFields: {
    firstName: "John",
    lastName: "Doe",
    dateOfBirth: "1990-01-01",
    phoneNumber: "555-1234",
    addressLine1: "123 Main St",
    city: "Springfield",
    state: "IL",
    zip: "62701"
  },
  results: [
    {
      groupId: "group-1",
      fullName: "John Doe",
      dateOfBirth: "1990-01-01",
      phoneNumber: {...},
      primaryAddress: {...},
      // ... more fields
    }
  ]
}
```

### ClearPersonReport (Comprehensive Report)

Contains detailed information including potential kin:

```ruby
{
  id: "456",
  status: 200,  # 200 = completed
  reportData: {
    status: 200,
    personalInformation: {...},
    potentialRelatives: [
      {
        entityId: "entity-1",
        fullName: "Jane Doe",
        relativeDegree: 1,  # 1 = sibling, 2 = cousin, etc.
        dateOfBirth: "1992-05-15",
        addresses: [...],
        phoneNumbers: [...],
        emailAddresses: [...]
      }
    ],
    potentialAssociates: [
      {
        entityId: "entity-2",
        fullName: "Bob Smith",
        // ... similar structure
      }
    ],
    socialMediaLinks: [...],
    riskFlags: [...]
  }
}
```

---

## Components

### Frontend Components (JavaScript/React)

#### 1. SearchForm (`SearchForm.js`)
**Purpose**: Form for entering search criteria

**Features**:
- Input fields for all search criteria
- Validation of field combinations
- Pre-population from AgencyHuman (if searching for existing person)
- Edit existing search functionality

**Key Code**:
```javascript
const SearchForm = ({ editingSearchId, agencyHuman }) => {
  const { formState, setFormAttribute } = useBintiForm(initialFormState);
  
  const validSearchCriteria = () => {
    // Validates that search has valid field combinations
    const presentFields = Object.keys(pickBy(formState));
    const invalid = invalidCombos.filter(/* validation logic */);
    return isEmpty(invalid);
  };
  
  const onSubmit = () => {
    createSearch({
      variables: { criteria: formState }
    });
  };
};
```

#### 2. SearchResults (`SearchResults.js`)
**Purpose**: Displays initial search results

**Features**:
- Table of search matches
- Shows search criteria used
- "More Details" button for each result
- "Edit Search" button to modify criteria

**Key Code**:
```javascript
const SearchResults = ({ searchId }) => {
  const { data } = useQuery(ClearPersonSearch, {
    variables: { id: searchId }
  });
  
  return (
    <Table>
      {clearPersonSearch.results.map(result => (
        <Tr key={result.groupId}>
          <Td>{result.fullName}</Td>
          <Td>{/* Personal information */}</Td>
          <Td>{/* Contact information */}</Td>
          <Td>
            <Button href={detailsPath(searchId, result.groupId)}>
              More Details
            </Button>
          </Td>
        </Tr>
      ))}
    </Table>
  );
};
```

#### 3. SearchResultDetails (`SearchResultDetails.js`)
**Purpose**: Detailed view of a single search result with comprehensive report

**Features**:
- Two tabs: Personal Information and Potential Kin
- "Run Comprehensive Search" button (if not run yet)
- Polling for report completion
- "Link as Connection" button
- "Download Report" button

**Key Code**:
```javascript
const SearchResultDetails = ({ searchId, groupId }) => {
  // Mutation to create comprehensive report
  const [createClearPersonReport] = useMutation(CreateClearPersonReport);
  
  // Query for comprehensive report (polls until status 200)
  const { data, startPolling, stopPolling } = useQuery(ClearPersonReport, {
    variables: { id: clearPersonReportId },
    skip: comprehensiveReportPending
  });
  
  // Poll every 1 second until report is ready
  useEffect(() => {
    if (!comprehensiveReportPending && reportData?.status !== 200) {
      startPolling(1000);
    }
    if (comprehensiveReportLoaded) {
      stopPolling();
    }
  }, [reportData, comprehensiveReportLoaded]);
  
  return (
    <ContentTabs
      tabs={[
        { title: "Personal Information", contents: <PersonalInformation /> },
        { title: "Potential Kin", contents: <PotentialKin /> }
      ]}
    />
  );
};
```

#### 4. PotentialKin (`PotentialKin.js`)
**Purpose**: Displays potential relatives and associates from comprehensive report

**Features**:
- Two tables: Potential Relatives and Potential Fictive Kin
- "Link All" button to link all potential kin at once
- Individual "Link as Connection" buttons

**Key Code**:
```javascript
const PotentialKin = ({
  reportData,
  comprehensiveReportPending,
  comprehensiveReportLoaded
}) => {
  const potentialKin = useMemo(() =>
    compact([
      ...(reportData.potentialRelatives || []),
      ...(reportData.potentialAssociates || [])
    ])
  );
  
  return (
    <>
      <PotentialKinTable
        caption="Potential Relatives"
        potentialKin={reportData?.potentialRelatives || []}
      />
      <PotentialKinTable
        caption="Potential Fictive Kin"
        potentialKin={reportData?.potentialAssociates || []}
      />
    </>
  );
};
```

#### 5. LinkPotentialConnectionModal (`LinkPotentialConnectionModal.js`)
**Purpose**: Modal for linking a potential connection to children

**Features**:
- Select which children to link
- Choose which data fields to include:
  - Name fields
  - Date of birth/death
  - SSN
  - Addresses
  - Phone numbers
  - Email addresses
  - Social media links
  - Risk flags
- Creates AgencyHuman record with selected data

**Key Code**:
```javascript
const LinkPotentialConnectionModal = ({
  searchData,
  socialMediaLinks,
  riskFlags,
  childAgencyHumans
}) => {
  const [createOrUpdateAgencyHuman] = useMutation(CreateOrUpdateAgencyHuman);
  
  const onSubmit = () => {
    createOrUpdateAgencyHuman({
      variables: {
        firstName: searchData?.firstName,
        lastName: searchData?.lastName,
        dateOfBirth: formState.dateOfBirth,
        addresses: addressInputs,
        phoneNumbers: phoneNumberInputs,
        emailAddresses: formState.emailAddresses,
        socialMediaLinks: formState.socialMediaLinks,
        riskFlags: formState.riskFlags ? riskFlags : [],
        childAgencyHumanIds: formState.childAgencyHumans.map(c => c.value),
        skipInvalidDataErrors: true
      }
    });
  };
};
```

### Backend Components (Ruby)

#### 1. Controller (`potential_kin_search_controller.rb`)
**Purpose**: Handles HTTP requests and renders views

**Actions**:
- `index`: Audit trail of searches
- `new`: New search form
- `show`: Search results
- `details`: Detailed result view

**Key Code**:
```ruby
class PotentialKinSearchController < ApplicationController
  def new
    authorize(FamilyFinding::ClearPersonSearch, :create?)
    
    agency_human_data = extract_agency_human_data
    render(locals: {
      editing_search_id: params[:editing_search_id],
      agency_human: agency_human_data.presence
    })
  end
  
  def show
    authorize_search
    render(locals: { search_id: params[:id] })
  end
end
```

#### 2. GraphQL Mutations

**CreateClearPersonSearch** (`create_clear_person_search.rb`)
- Creates a search record
- Sends search to CLEAR API
- Returns search with initial results

**CreateClearPersonReport** (`create_clear_person_report.rb`)
- Creates a comprehensive report record
- Triggers CLEAR to generate detailed report
- Returns report ID (used for polling)

**CreateOrUpdateAgencyHuman** (used when linking connections)
- Creates or updates AgencyHuman record
- Creates relationships to children
- Includes data from search results

#### 3. GraphQL Queries

**ClearPersonSearch** (`clear_person_search.rb`)
- Returns search criteria and initial results

**ClearPersonSearchDetail** (`clear_person_search_detail.rb`)
- Returns detailed information about a specific result

**ClearPersonReport** (`clear_person_report.rb`)
- Returns comprehensive report data
- Includes potential relatives and associates
- Polled until status is 200 (completed)

#### 4. Models

**ClearPersonReportPotentialKin** (`clear_person_report_potential_kin.rb`)
- Parses XML from CLEAR API
- Extracts person information:
  - Name, date of birth, addresses
  - Phone numbers, email addresses
  - Relative degree (for relatives)
  - Date of death

**Key Code**:
```ruby
class ClearPersonReportPotentialKin
  def full_name
    [prefix, first_name, middle_name, last_name, suffix]
      .join(" ").squish
  end
  
  def addresses
    @addresses ||= address_nodes.map do |address_node|
      FamilyFinding::ClearPersonAddress.new(node: address_node)
    end
  end
  
  def relative_degree
    node.xpath(".//RelativeDegree")&.text&.to_i
  end
end
```

---

## Data Flow

### Search Creation Flow

```
1. User fills out search form (client-side)
   ↓
2. User clicks "Search"
   ↓
3. GraphQL Mutation: CreateClearPersonSearch
   POST /graphql
   mutation CreateClearPersonSearch($criteria: ClearPersonSearchCriteriaInput!)
   ↓
4. Rails GraphQL Resolver
   - Validates criteria
   - Creates ClearPersonSearch record
   - Calls CLEAR API with search criteria
   ↓
5. CLEAR API returns initial results
   ↓
6. Results stored in database
   ↓
7. GraphQL returns search with results
   ↓
8. Client redirects to results page
   /family_finding/potential_kin_search/:id
```

### Comprehensive Report Flow

```
1. User clicks "Run Comprehensive Search"
   ↓
2. GraphQL Mutation: CreateClearPersonReport
   POST /graphql
   mutation CreateClearPersonReport($searchId: ID!, $groupId: String!)
   ↓
3. Rails creates ClearPersonReport record
   - Triggers CLEAR API to generate comprehensive report
   - Report generation is asynchronous
   ↓
4. Client starts polling
   - Queries ClearPersonReport every 1 second
   - Checks if status === 200 (completed)
   ↓
5. CLEAR API generates report
   - Finds potential relatives
   - Finds potential associates
   - Gathers social media links
   - Identifies risk flags
   ↓
6. Report data stored/returned
   ↓
7. Polling stops when status === 200
   ↓
8. UI displays potential kin in tables
```

### Connection Linking Flow

```
1. User clicks "Link as Potential Connection"
   ↓
2. Modal opens: LinkPotentialConnectionModal
   - User selects children to link
   - User selects data fields to include
   ↓
3. User clicks "Create New Potential Connections"
   ↓
4. GraphQL Mutation: CreateOrUpdateAgencyHuman
   POST /graphql
   mutation CreateOrUpdateAgencyHuman(
     $firstName: String!,
     $lastName: String!,
     $childAgencyHumanIds: [ID!]!,
     $addresses: [AddressInput!],
     $phoneNumbers: [PhoneNumberInput!],
     ...
   )
   ↓
5. Rails creates AgencyHuman record
   - Includes selected data fields
   - Creates relationships to selected children
   - Sets relationship type as "potential connection"
   ↓
6. Success modal shown
   ↓
7. Connection appears in Relationships dashboard
```

---

## Integration with CLEAR API

### Search Request

The system sends search criteria to CLEAR API:

```ruby
{
  firstName: "John",
  lastName: "Doe",
  dateOfBirth: "1990-01-01",
  phoneNumber: "555-1234",
  addressLine1: "123 Main St",
  city: "Springfield",
  state: "IL",
  zip: "62701"
}
```

### Search Response

CLEAR returns initial matches:

```xml
<SearchResults>
  <Result>
    <GroupId>group-1</GroupId>
    <PersonInfo>
      <PersonName>
        <FirstName>John</FirstName>
        <LastName>Doe</LastName>
      </PersonName>
      <PersonProfile>
        <PersonBirthDate>01/01/1990</PersonBirthDate>
      </PersonProfile>
    </PersonInfo>
    <AddressInfo>
      <AddressLine1>123 Main St</AddressLine1>
      <City>Springfield</City>
      <State>IL</State>
      <Zip>62701</Zip>
    </AddressInfo>
    <!-- More fields -->
  </Result>
</SearchResults>
```

### Comprehensive Report Response

CLEAR returns detailed report with potential kin:

```xml
<ComprehensiveReport>
  <PersonalInformation>
    <!-- Detailed personal info -->
  </PersonalInformation>
  <PotentialRelatives>
    <Relative>
      <EntityId>entity-1</EntityId>
      <RelativeDegree>1</RelativeDegree>
      <PersonInfo>
        <PersonName>
          <FirstName>Jane</FirstName>
          <LastName>Doe</LastName>
        </PersonName>
      </PersonInfo>
      <!-- More fields -->
    </Relative>
  </PotentialRelatives>
  <PotentialAssociates>
    <Associate>
      <EntityId>entity-2</EntityId>
      <!-- Similar structure -->
    </Associate>
  </PotentialAssociates>
  <SocialMediaLinks>
    <!-- Social media profiles -->
  </SocialMediaLinks>
  <RiskFlags>
    <!-- Risk indicators -->
  </RiskFlags>
</ComprehensiveReport>
```

---

## Key Features

### 1. Search Validation

The system validates search criteria to ensure useful results:

- Prevents searches that are too vague (e.g., first name only)
- Ensures minimum required information
- Validates field combinations

**Invalid Combinations**:
```javascript
const invalidCombos = [
  ["firstName"],  // Too vague
  ["firstName", "middleName"],  // Still too vague
  ["dateOfBirth"],  // Not enough
  ["city"],  // Not enough
  // ... more invalid combinations
];
```

### 2. Flexible Search

Users can enable "Flexible Search" which:
- Uses fuzzy matching
- Handles name variations
- Finds similar names/spellings

### 3. Comprehensive Report Polling

The system polls for report completion:
- Starts polling when report is created
- Polls every 1 second
- Stops when status === 200
- Shows loading state during polling

### 4. Data Selection When Linking

When linking a connection, users can choose:
- Which children to link to
- Which data fields to include
- Whether to include social media links
- Whether to include risk flags

### 5. Batch Linking

Users can link all potential kin at once:
- "Link All Potential Kin as Potential Connections" button
- Opens modal to select children and data fields
- Creates multiple connections in one operation

### 6. Audit Trail

The system tracks:
- Who ran searches
- When searches were run
- Search criteria used
- Results found

---

## File Structure

### Frontend Files

```
app/javascript/components/family_finding/potential_kin_search/
├── PotentialKin.js                    # Main component for potential kin display
├── PotentialKinTable.js               # Table component for displaying kin
├── SearchForm.js                      # Search criteria form
├── SearchResults.js                   # Initial search results display
├── SearchResultDetails.js             # Detailed result view
├── LinkPotentialConnectionModal.js    # Modal for linking connections
├── LinkAllPotentialConnectionsModal.js # Modal for batch linking
├── PersonalInformation.js            # Personal info tab content
├── ConfirmationModal.js               # Confirmation dialogs
├── ResultModalNotice.js               # Success/error notices
└── modalConversions.js                # Data conversion utilities
```

### Backend Files

```
app/
├── controllers/family_finding/
│   └── potential_kin_search_controller.rb
├── models/family_finding/
│   ├── clear_person_report_potential_kin.rb
│   └── clear_person_search.rb
├── graphql/
│   ├── mutations/
│   │   ├── create_clear_person_search.rb
│   │   └── create_clear_person_report.rb
│   └── queries/
│       ├── clear_person_search.rb
│       ├── clear_person_search_detail.rb
│       └── clear_person_report.rb
└── lib/services/family_finding/
    └── clear_person_search/           # Service objects for CLEAR integration
```

### GraphQL Files

```
app/javascript/graphql/
├── mutations/
│   ├── CreateClearPersonSearch.graphql
│   └── CreateClearPersonReport.graphql
└── queries/
    ├── ClearPersonSearch.graphql
    ├── ClearPersonSearchDetail.graphql
    └── ClearPersonReport.graphql
```

---

## Relationship to ENG-24262 Issue

The PKOS feature is related to the blank screen issue (ENG-24262) because:

1. **Connection Creation**: When PKOS creates connections via `LinkPotentialConnectionModal`, it uses `CreateOrUpdateAgencyHuman` mutation
2. **Incomplete Data**: Sometimes PKOS creates connections with incomplete data (null `destinationAgencyHuman` or `sourceAgencyHuman`)
3. **Null Handling**: The UI wasn't prepared to handle null data from PKOS-created connections

**The Fix**: Added null handling throughout the relationships components to gracefully handle incomplete data from PKOS connections.

---

## Best Practices

### For Users

1. **Use Sufficient Search Criteria**: Include enough information for accurate results
2. **Review Results Carefully**: Verify information before linking connections
3. **Select Relevant Data**: Only include data fields that are accurate and useful
4. **Use Comprehensive Search**: Run comprehensive search for detailed potential kin information

### For Developers

1. **Handle Null Data**: Always check for null/undefined values from PKOS results
2. **Validate Search Criteria**: Ensure valid field combinations before sending to CLEAR
3. **Poll Efficiently**: Use appropriate polling intervals for report status
4. **Error Handling**: Handle CLEAR API errors gracefully
5. **Data Mapping**: Properly map CLEAR API responses to internal data structures

---

## Summary

The Potential Kin Online Search (PKOS) feature is a powerful tool for child welfare workers to:

- **Search** for potential relatives and connections using external data sources
- **Discover** extended family members and associates
- **Link** discovered people as connections in the system
- **Build** comprehensive family networks for children in care

The feature integrates with Thomson Reuters CLEAR to provide:
- Initial search results (basic matches)
- Comprehensive reports (detailed potential kin)
- Personal information (addresses, phone numbers, etc.)
- Social media links
- Risk flags

The system handles the complexity of:
- Validating search criteria
- Polling for report completion
- Mapping external data to internal structures
- Creating connections with selected data fields

This feature is essential for family finding work, helping workers locate and connect with family members who may not be in the system initially.
